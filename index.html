<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Aplicação Fertilizante Fluido</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#007bff"/>
    <style>
        /* Seus estilos CSS permanecem os mesmos */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f4;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 20px auto;
        }
        h1, h2 {
            text-align: center;
            color: #333;
            font-size: 1.5em;
        }
        .section {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .section-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 15px;
            color: #555;
            font-size: 1.2em;
        }
        .form-group {
            margin-bottom: 10px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }
        .form-group label {
            flex: 0 0 150px;
            margin-right: 10px;
            text-align: right;
            font-weight: bold;
            color: #666;
            box-sizing: border-box;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group input[type="time"] {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            min-width: 150px;
        }
        .form-group.inline-fields {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .form-group.inline-fields .field-pair {
            display: flex;
            align-items: center;
            flex: 1 1 48%;
            margin-bottom: 10px;
        }
        .form-group.inline-fields .field-pair label {
            flex: 0 0 auto;
            margin-right: 5px;
            text-align: left;
        }
        .form-group.inline-fields .field-pair input {
            flex: 1;
        }
        .radio-group {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        .radio-group input[type="radio"] {
            margin-right: 5px;
        }
        .radio-group label {
            margin-right: 15px;
        }
        textarea {
            width: 100%;
            min-height: 80px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .signature-section {
            text-align: center;
            margin-top: 40px;
            border-top: 1px dashed #ccc;
            padding-top: 20px;
        }
        .signature-line {
            width: 60%;
            margin: 0 auto 10px auto;
            border-bottom: 1px solid #000;
            padding-top: 20px;
        }
        .signature-label {
            margin-top: 5px;
            font-weight: bold;
        }
        .signature-name {
            margin-top: 20px;
            font-weight: bold;
        }
        .button-group {
            text-align: center;
            margin-top: 30px;
        }
        .button-group button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .button-group button:hover {
            background-color: #0056b3;
        }
        @media screen and (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
            h1 { font-size: 1.3em; }
            h2.section-title { font-size: 1.1em; }
            .form-group {
                flex-direction: column;
                align-items: flex-start;
            }
            .form-group label {
                flex: none;
                width: 100%;
                text-align: left;
                margin-right: 0;
                margin-bottom: 5px;
            }
            .form-group input[type="text"],
            .form-group input[type="number"],
            .form-group input[type="date"],
            .form-group input[type="time"],
            textarea {
                width: 100%;
                min-width: unset;
            }
            .form-group.inline-fields {
                flex-direction: column;
            }
            .form-group.inline-fields .field-pair {
                flex: 1 1 100%;
                flex-direction: column;
                align-items: flex-start;
            }
            .form-group.inline-fields .field-pair label {
                width: 100%;
                text-align: left;
                margin-bottom: 5px;
            }
            .form-group.inline-fields .field-pair input {
                width: 100%;
            }
            .radio-group {
                flex-direction: column;
                align-items: flex-start;
            }
            .radio-group label {
                margin-bottom: 5px;
            }
            .signature-line {
                width: 90%;
            }
        }
        @media screen and (max-width: 480px) {
            .container { padding: 10px; }
            h1 { font-size: 1.2em; }
            h2.section-title { font-size: 1em; }
            .button-group button {
                width: 90%;
                font-size: 14px;
                padding: 8px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Relatório de Aplicação Fertilizante Fluido.</h1>
        <div class="section">
            <div class="form-group">
                <label for="empresa">Empresa:</label>
                <input type="text" id="empresa" name="empresa" value="Terrena Agronegócios Ltda." readonly>
            </div>
            <div class="form-group">
                <label for="endereco">Endereço:</label>
                <input type="text" id="endereco" name="endereco" value="Av. Rodrigo C. Avellar 1416. Bairro: Distrito Industrial." readonly>
            </div>
            <div class="form-group">
                <label for="cidade_empresa">Cidade:</label>
                <input type="text" id="cidade_empresa" name="cidade_empresa" value="Patos de Minas MG CEP: 38706-706" readonly>
            </div>
        </div>
        <div class="section">
            <div class="form-group">
                <label for="cliente">Cliente:</label>
                <input type="text" id="cliente" name="cliente" required>
            </div>
            <div class="form-group inline-fields">
                <div class="field-pair">
                    <label for="fazenda">Fazenda:</label>
                    <input type="text" id="fazenda" name="fazenda" required>
                </div>
                <div class="field-pair">
                    <label for="cidade_fazenda">Cidade:</label>
                    <input type="text" id="cidade_fazenda" name="cidade_fazenda" required>
                </div>
            </div>
            <div class="form-group inline-fields">
                <div class="field-pair">
                    <label for="operador">Operador:</label>
                    <input type="text" id="operador" name="operador" required>
                </div>
            </div>
            <div class="form-group inline-fields">
                <div class="field-pair">
                    <label for="data_aplicacao">Data Aplicação:</label>
                    <input type="date" id="data_aplicacao" name="data_aplicacao" required>
                </div>
                <div class="field-pair">
                    <label for="n_pedido">Nº Pedido:</label>
                    <input type="text" id="n_pedido" name="n_pedido" required>
                </div>
            </div>
        </div>
        <div class="section">
            <h2 class="section-title">Descrição da Aplicação.</h2>
            <div class="form-group">
                <label for="modelo_equipamento">Modelo do Equipamento:</label>
                <input type="text" id="modelo_equipamento" name="modelo_equipamento" required>
            </div>
            <div class="form-group">
                <label for="talhao">Talhão:</label>
                <input type="text" id="talhao" name="talhao" required>
            </div>
            <div class="form-group inline-fields">
                <div class="field-pair">
                    <label for="ha_aplicado">Há Aplicado:</label>
                    <input type="number" id="ha_aplicado" name="ha_aplicado" step="0.01" required>
                </div>
                <div class="field-pair">
                    <label for="ha_feita">Há Feita:</label>
                    <input type="number" id="ha_feita" name="ha_feita" step="0.01" required>
                </div>
            </div>
            <div class="form-group inline-fields">
                <div class="field-pair">
                    <label for="hora_aplicado">Hora Aplicado:</label>
                    <input type="time" id="hora_aplicado" name="hora_aplicado" required>
                </div>
                <div class="field-pair">
                    <label for="transpasse">Transpasse:</label>
                    <input type="text" id="transpasse" name="transpasse" required>
                </div>
            </div>
            <div class="form-group inline-fields">
                <div class="field-pair">
                    <label for="velocidade_media">Velocidade Média:</label>
                    <input type="number" id="velocidade_media" name="velocidade_media" step="0.01" required>
                </div>
                <div class="field-pair">
                    <label for="kg_ha">Kg/ha:</label>
                    <input type="number" id="kg_ha" name="kg_ha" step="0.01" required>
                </div>
            </div>
            <div class="form-group">
                <label>Houve Ocorrência:</label>
                <div class="radio-group">
                    <input type="radio" id="ocorrencia_sim" name="ocorrencia" value="Sim" required>
                    <label for="ocorrencia_sim">Sim</label>
                    <input type="radio" id="ocorrencia_nao" name="ocorrencia" value="Não">
                    <label for="ocorrencia_nao">Não</label>
                </div>
            </div>
            <div class="form-group">
                <label for="cultura">Cultura:</label>
                <input type="text" id="cultura" name="cultura" required>
            </div>
        </div>
        <div class="section">
            <label for="ocorrencia_texto">Descrição da Ocorrência:</label>
            <textarea id="ocorrencia_texto" name="ocorrencia_texto" rows="5"></textarea>
        </div>
        <div class="signature-section">
            <div class="form-group">
                <label for="nome_assinatura">Nome:</label>
                <input type="text" id="nome_assinatura" name="nome_assinatura" required>
            </div>
            <div class="form-group">
                <label for="assinatura">Assinatura:</label>
                <input type="text" id="assinatura" name="assinatura" placeholder="Assine aqui, ou deixe para impressão." required>
            </div>
        </div>
        <div class="button-group">
            <button type="submit" id="enviarRelatorioBtn">Gerar e Compartilhar Relatório</button>
        </div>
    </div>
    <script>
        const { jsPDF } = window.jspdf;
        const enviarRelatorioBtn = document.getElementById('enviarRelatorioBtn');
        const form = document.querySelector('.container');

        form.addEventListener('submit', async function(event) {
            event.preventDefault(); // Impede o envio padrão do formulário

            const data = getFormData();
            
            // Validação final de campos obrigatórios
            const camposObrigatorios = [
                'cliente', 'fazenda', 'cidade_fazenda', 'operador', 'data_aplicacao',
                'n_pedido', 'modelo_equipamento', 'talhao', 'ha_aplicado', 'ha_feita',
                'hora_aplicado', 'transpasse', 'velocidade_media', 'kg_ha', 'cultura',
                'nome_assinatura', 'assinatura'
            ];
            
            for (const campo of camposObrigatorios) {
                if (!data[campo] || (campo === 'ocorrencia_texto' && data.houveOcorrencia === 'Sim' && !data[campo])) {
                    alert('Por favor, preencha todos os campos obrigatórios.');
                    // Foca no campo que está faltando para o usuário
                    document.getElementById(campo).focus();
                    return; // Interrompe a função se a validação falhar
                }
            }
            
            // Validação do campo de rádio 'Houve Ocorrência'
            const radioOcorrencia = document.querySelector('input[name="ocorrencia"]:checked');
            if (!radioOcorrencia) {
                alert('Por favor, selecione se houve uma ocorrência.');
                document.getElementById('ocorrencia_sim').focus();
                return;
            }

            // Validação da descrição da ocorrência se "Sim" for selecionado
            if (data.houveOcorrencia === 'Sim' && data.ocorrencia_texto.trim() === '') {
                alert('Você selecionou "Sim" para ocorrência. Por favor, preencha a descrição.');
                document.getElementById('ocorrencia_texto').focus();
                return;
            }

            // Se a validação passou, continua com a geração do PDF
            const doc = new jsPDF();
            let y = 10;
            doc.setFontSize(16);
            doc.text("Relatório de Aplicação Fertilizante Fluido", 105, y, { align: "center" });
            y += 10;
            doc.setFontSize(12);
            y += 5;
            doc.text("--- Dados da Empresa ---", 10, y); y += 7;
            doc.text(`Empresa: ${data.empresa}`, 10, y); y += 7;
            doc.text(`Endereço: ${data.endereco}`, 10, y); y += 7;
            doc.text(`Cidade (Empresa): ${data.cidade_empresa}`, 10, y); y += 10;
            doc.text("--- Dados do Cliente e Aplicação ---", 10, y); y += 7;
            doc.text(`Cliente: ${data.cliente}`, 10, y); y += 7;
            doc.text(`Fazenda: ${data.fazenda}`, 10, y); y += 7;
            doc.text(`Cidade (Fazenda): ${data.cidade_fazenda}`, 10, y); y += 7;
            doc.text(`Operador: ${data.operador}`, 10, y); y += 7;
            doc.text(`Data Aplicação: ${data.data_aplicacao}`, 10, y); y += 7;
            doc.text(`Nº Pedido: ${data.n_pedido}`, 10, y); y += 10;
            doc.text("--- Descrição da Aplicação ---", 10, y); y += 7;
            doc.text(`Modelo Equipamento: ${data.modelo_equipamento}`, 10, y); y += 7;
            doc.text(`Talhão: ${data.talhao}`, 10, y); y += 7;
            doc.text(`Há Aplicado: ${data.ha_aplicado}`, 10, y); y += 7;
            doc.text(`Há Feita: ${data.ha_feita}`, 10, y); y += 7;
            doc.text(`Hora Aplicado: ${data.hora_aplicado}`, 10, y); y += 7;
            doc.text(`Transpasse: ${data.transpasse}`, 10, y); y += 7;
            doc.text(`Velocidade Média: ${data.velocidade_media}`, 10, y); y += 7;
            doc.text(`Kg/ha: ${data.kg_ha}`, 10, y); y += 7;
            doc.text(`Houve Ocorrência: ${data.houveOcorrencia}`, 10, y); y += 7;
            doc.text(`Cultura: ${data.cultura}`, 10, y); y += 10;
            
            if (data.ocorrencia_texto.trim() !== '') {
                doc.text("--- Detalhes da Ocorrência ---", 10, y); y += 7;
                const splitText = doc.splitTextToSize(data.ocorrencia_texto, 180);
                doc.text(splitText, 10, y);
                y += (splitText.length * 7) + 10;
            }
            doc.text("--- Assinatura ---", 10, y); y += 7;
            doc.text(`Nome: ${data.nome_assinatura}`, 10, y); y += 7;
            doc.text(`Assinatura: ${data.assinatura}`, 10, y); y += 7;
            
            const dataHoje = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
            const nomeArquivo = `Relatorio_Fertilizante_${dataHoje}_${data.cliente || 'Sem Cliente'}.pdf`;
            const pdfBlob = doc.output('blob');
            const pdfFile = new File([pdfBlob], nomeArquivo, { type: 'application/pdf' });
            
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                try {
                    await navigator.share({
                        files: [pdfFile],
                        title: 'Relatório de Aplicação Fertilizante Fluido',
                        text: `Segue o relatório de aplicação de fertilizante fluido para ${data.cliente || 'o cliente'}.`
                    });
                    console.log('PDF compartilhado com sucesso via Web Share API.');
                } catch (error) {
                    console.error('Erro ao compartilhar PDF via Web Share API (usuário cancelou ou falha):', error);
                    doc.save(nomeArquivo);
                    sendWhatsAppTextMessage(data, nomeArquivo);
                }
            } else {
                console.log('Web Share API para arquivos não suportada neste dispositivo/navegador.');
                doc.save(nomeArquivo);
                sendWhatsAppTextMessage(data, nomeArquivo);
                alert('O PDF foi baixado para o seu dispositivo. Por favor, anexe-o manualmente no WhatsApp. Uma mensagem de texto já foi preparada.');
            }
        });

        function getFormData() {
            const data = {};
            const ids = [
                'empresa', 'endereco', 'cidade_empresa', 'cliente', 'fazenda', 'cidade_fazenda',
                'operador', 'data_aplicacao', 'n_pedido', 'modelo_equipamento',
                'talhao', 'ha_aplicado', 'ha_feita', 'hora_aplicado', 'transpasse',
                'velocidade_media', 'kg_ha', 'cultura', 'ocorrencia_texto', 'nome_assinatura', 'assinatura'
            ];
            ids.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    data[id] = element.value;
                }
            });
            data.houveOcorrencia = '';
            if (document.getElementById('ocorrencia_sim').checked) {
                data.houveOcorrencia = 'Sim';
            } else if (document.getElementById('ocorrencia_nao').checked) {
                data.houveOcorrencia = 'Não';
            }
            return data;
        }

        function sendWhatsAppTextMessage(data, fileName) {
            let mensagemWhatsApp = `*Relatório de Aplicação Fertilizante Fluido*\n\n`;
            mensagemWhatsApp += `--- Dados da Empresa ---\n`;
            mensagemWhatsApp += `Empresa: ${data.empresa}\n`;
            mensagemWhatsApp += `Endereço: ${data.endereco}\n`;
            mensagemWhatsApp += `Cidade (Empresa): ${data.cidade_empresa}\n\n`;
            mensagemWhatsApp += `--- Dados do Cliente e Aplicação ---\n`;
            mensagemWhatsApp += `Cliente: ${data.cliente || 'Não preenchido'}\n`;
            mensagemWhatsApp += `Fazenda: ${data.fazenda || 'Não preenchida'}\n`;
            mensagemWhatsApp += `Cidade (Fazenda): ${data.cidade_fazenda || 'Não preenchida'}\n`;
            mensagemWhatsApp += `Operador: ${data.operador || 'Não preenchido'}\n`;
            mensagemWhatsApp += `Data Aplicação: ${data.data_aplicacao || 'Não preenchida'}\n`;
            mensagemWhatsApp += `Nº Pedido: ${data.n_pedido || 'Não preenchido'}\n\n`;
            mensagemWhatsApp += `--- Descrição da Aplicação ---\n`;
            mensagemWhatsApp += `Modelo Equipamento: ${data.modelo_equipamento || 'Não preenchido'}\n`;
            mensagemWhatsApp += `Talhão: ${data.talhao || 'Não preenchido'}\n`;
            mensagemWhatsApp += `Há Aplicado: ${data.ha_aplicado || 'Não preenchido'}\n`;
            mensagemWhatsApp += `Há Feita: ${data.ha_feita || 'Não preenchido'}\n`;
            mensagemWhatsApp += `Hora Aplicado: ${data.hora_aplicado || 'Não preenchida'}\n`;
            mensagemWhatsApp += `Transpasse: ${data.transpasse || 'Não preenchido'}\n`;
            mensagemWhatsApp += `Velocidade Média: ${data.velocidade_media || 'Não preenchida'}\n`;
            mensagemWhatsApp += `Kg/ha: ${data.kg_ha || 'Não preenchido'}\n`;
            mensagemWhatsApp += `Houve Ocorrência: ${data.houveOcorrencia || 'Não preenchido'}\n`;
            mensagemWhatsApp += `Cultura: ${data.cultura || 'Não preenchida'}\n\n`;
            if (data.ocorrencia_texto.trim() !== '') {
                mensagemWhatsApp += `--- Detalhes da Ocorrência ---\n`;
                mensagemWhatsApp += `${data.ocorrencia_texto}\n\n`;
            }
            mensagemWhatsApp += `--- Assinatura ---\n`;
            mensagemWhatsApp += `Nome: ${data.nome_assinatura || 'Não preenchido'}\n`;
            mensagemWhatsApp += `Assinatura: ${data.assinatura || 'Não preenchido'}\n`;
            mensagemWhatsApp += `\n\n_O arquivo PDF "${fileName}" foi baixado. Por favor, anexe-o nesta conversa._`;

            const mensagemCodificada = encodeURIComponent(mensagemWhatsApp);
            const numeroWhatsApp = '5534999422263';
            const whatsappURL = `https://wa.me/${numeroWhatsApp}?text=${mensagemCodificada}`;
            window.open(whatsappURL, '_blank');
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const publicPath = new URL(location.href).pathname.replace(/\/[^/]*$/, '/');
                const serviceWorkerPath = `${publicPath}service-worker.js`;
                navigator.serviceWorker.register(serviceWorkerPath)
                    .then(registration => {
                        console.log('Service Worker registrado com sucesso:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Falha no registro do Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>
